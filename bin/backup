#!/bin/bash

set -eux
set -o pipefail
shopt -s dotglob

spec=$1
sourcedir=$2
name=$3

repo=$(cat $spec | jq --raw-output .local_repo)
zbackup_file=$repo/backups/$name
gdrive_folder=$(cat $spec | jq --raw-output .gdrive_folder_id)

pwfile=$(mktemp /tmp/haven-pwXXXXX)
echo $(cat $spec | jq --raw-output .zbackup_password) > $pwfile

archive() {
  cd $sourcedir
  tar c *
}

anywait() {
  set +e
  while kill -0 "$1"; do
      sleep 0.5
  done
  set -e
}

chunksize=$((1024 * 1000))

archive | PWFILE=$pwfile SYNC_CMD="go run /Users/jonas/code/haven/gdrivesync/main.go --archive-and-delete $gdrive_folder" go run zbackup-splitter/main.go $chunksize $zbackup_file bin/after_part
archive | zbackup backup --password-file $pwfile $zbackup_file
bin/after_part $zbackup_file

rm $pwfile

echo "Backup done, waiting for Google Drive sync to finish"

# wait for the sync to finish
syncfile="$repo/tmp/syncpid"
syncpid=$(cat $syncfile)
rm $syncfile # this triggers the exit
anywait $syncpid

pushd $repo
rmdir tmp
# finally, archive the metadata
go run ~/code/haven/gdrivesync/main.go $gdrive_folder
popd
