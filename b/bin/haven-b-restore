#!/bin/bash

set -eux
set -o pipefail

spec=$1
name=$2
restore_to=$3
gdrive_folder=$(cat $spec | jq --raw-output .gdrive_folder_id)

if [ -e "$restore_to" ]
then
  echo "$restore_to already exists!"
  exit 1
fi

tmp=$(mktemp -d /tmp/haven-restoreXXXXX)
pushd $tmp
haven-b-gdriverestore $gdrive_folder
# write out the info file (containing the backup key)
cat $spec | jq --raw-output .zbackup_info_base64 | base64 -D > info
popd $tmp

if [ -e "$restore_to" ]
then
  echo "$restore_to already exists!"
  exit 1
fi
mkdir $restore_to

mv $tmp/{archived_bundles,bundles}

pwfile=$(mktemp /tmp/haven-pwXXXXX)
echo $(cat $spec | jq --raw-output .zbackup_password) > $pwfile

pushd $restore_to
zbackup restore --password-file $pwfile $tmp/backups/$name | tar x
rm $pwfile
# fix file ownership: restore to the current user and effective group id
chown -R `whoami`:`id -Gn|cut -d ' ' -f 1` *
popd
