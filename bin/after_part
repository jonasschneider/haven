#!/bin/bash

set -eux

backup=$1
bundles="$(dirname $backup)/../bundles"

blocks=$(du -sk $bundles | cut -f 1)
echo "du: $((blocks*1000))"

# simulate moving away all the bundles (i.e. archiving to S3)
archive="$bundles/../archived_bundles"
mkdir -p $archive
pushd $bundles
ls | xargs -I {} mkdir -p $archive/{}
find . -type f | xargs -n 1 -I {} mv {} $archive/{}
popd
rmdir $bundles/* || true

syncfile="$bundles/../tmp/syncpid"
if [ -f $syncfile ]
then
  echo "sync already running -- not starting again"
else
  echo "starting sync"
  mkdir -p $(dirname $syncfile)
  touch $syncfile
  pushd $bundles/..
  EXIT_ON_ABSENT=$syncfile $SYNC_CMD &
  popd
  echo $! > $syncfile
fi
