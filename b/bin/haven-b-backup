#!/bin/bash

set -eu
set -o pipefail

snapshot=$1
filename=$(date "+%Y-%m-%d-%H-%M")-$2.zfs.xz.gpg
gdrive_folder=0B7l3QydqgCmffi0za0NPMnpFbUF3aU5UbjJCVHBCV0dUWDhlRE5EdnFsV0JILVYyMU1ZOVk
recipient_keyname=mail@jonasschneider.com
hashfile=$(mktemp /tmp/hashfileXXXXXXXXX)
sizefile=$(mktemp /tmp/sizefileXXXXXXXXX)
start_t=$(date)

zfs send $snapshot \
  | tee >(sha256sum > $hashfile) \
  | tee >(wc -c > $sizefile) \
  | xz \
  | gpg -e -r $recipient_keyname --cipher-algo AES256 --compress-algo none \
  | buffer -m 32M -s 512K \
  | haven-b-upload $filename $gdrive_folder \
  | read gdrive_fileid

thehash=$(cat $hashfile)
rm $hashfile
thesize=$(cat $sizefile)
rm $sizefile

echo "========================================================"
echo "Completed Backup: $filename"
echo "Of ZFS snapshot:  $snapshot"
echo "ZFS stream size:  $thesize"
echo "ZFS stream SHA1:  $thehash"
echo "Encrypted to:     $recipient_keyname"
echo "In GDrive as:     $gdrive_fileid"
echo "Within folder:    $gdrive_folder"
echo "Time start:       $start_t"
echo "Time end:         $(date)"
echo "Host:             $(hostname)"
echo "========================================================"
